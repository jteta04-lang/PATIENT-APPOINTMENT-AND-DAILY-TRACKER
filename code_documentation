## DDL

** CREATING TABLES **

---- TABLE CREATION----
  ---1.departments
CREATE TABLE DEPARTMENTS (
department_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
dept_code VARCHAR2(10) NOT NULL UNIQUE,
dept_name VARCHAR2(100) NOT NULL,
active    CHAR(1) DEFAULT 'Y' CHECK (active IN ('Y','N'))
);

  ---2.users/staff
CREATE TABLE users_staff (
    staff_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username VARCHAR2(50) NOT NULL UNIQUE,
    full_name VARCHAR(100) NOT NULL,
    role VARCHAR(50) DEFAULT 'CLERK' CHECK (role IN ('ADMIN','DOCTOR','NURSE','CLERK','RECEPTION')),
    email VARCHAR(100),
    created_on DATE DEFAULT SYSDATE NOT NULL
);

  ---3.Patients
CREATE TABLE patients (
    patient_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    national_id VARCHAR2(20) UNIQUE,
    first_name VARCHAR(20) NOT NULL,
    last_name VARCHAR(20) NOT NULL,
    gender VARCHAR(10) DEFAULT 'OTHER' 
        CHECK (gender IN ('M','F','OTHER')),
    date_of_birth DATE,
    phone VARCHAR2(20),
    email VARCHAR2(100),
    address VARCHAR2(200),
    created_on DATE DEFAULT SYSDATE NOT NULL
);

ALTER TABLE patients
ADD last_visit DATE;


 ---4.Doctors
CREATE TABLE doctors (
    doctor_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    doctor_code VARCHAR2(20) NOT NULL UNIQUE,
    full_name VARCHAR(120) NOT NULL,
    department_id NUMBER NOT NULL,
    phone VARCHAR2(20),
    email VARCHAR2(100),
    active CHAR(1) DEFAULT 'Y' CHECK (active IN ('Y','N')),
    
    CONSTRAINT fk_doctor_dept FOREIGN KEY (department_id)
    REFERENCES departments(department_id)
);

ALTER TABLE doctors
ADD (
    first_name VARCHAR2(50),
    last_name VARCHAR2(50)
);


  ---5.Appointments
CREATE TABLE appointments (
    appointment_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    appointment_no VARCHAR2(50) NOT NULL,  -- You need to define a length for VARCHAR2
    patient_id NUMBER NOT NULL,
    doctor_id NUMBER NOT NULL,
    department_id NUMBER NOT NULL,
    appointment_date DATE NOT NULL,
    appointment_time VARCHAR2(10),
    status VARCHAR2(20) DEFAULT 'SCHEDULED'
        CHECK (status IN ('SCHEDULED', 'COMPLETED', 'CANCELLED', 'NO_SHOW')),
    reason VARCHAR2(4000),  -- Ensure this is the intended size
    created_by NUMBER,
    created_on DATE DEFAULT SYSDATE NOT NULL,
    
    CONSTRAINT fk_appt_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id),
    CONSTRAINT fk_appt_doctor FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id),
    CONSTRAINT fk_appt_dept FOREIGN KEY (department_id) REFERENCES departments(department_id)
);

 ---6.Visits(daily log)
 CREATE TABLE visits (
    visit_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    visit_no VARCHAR2(30) NOT NULL UNIQUE,  -- Corrected data type (VARCHAR2)
    patient_id NUMBER NOT NULL,
    doctor_id NUMBER,
    department_id NUMBER NOT NULL,
    visit_date DATE NOT NULL,
    visit_time VARCHAR2(10),
    visit_type VARCHAR2(20) DEFAULT 'OUTPATIENT'
        CHECK (visit_type IN ('OUTPATIENT', 'INPATIENT', 'EMERGENCY')),
    visit_status VARCHAR2(20) DEFAULT 'ATTENDED'
        CHECK (visit_status IN ('ATTENDED', 'LEFT', 'REFERRED', 'DIED')),
    notes VARCHAR2(4000),
    registered_by NUMBER,
    registered_on DATE DEFAULT SYSDATE NOT NULL,
    
    CONSTRAINT fk_visit_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id),
    CONSTRAINT fk_visit_doctor FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id),  -- Corrected table name
    CONSTRAINT fk_visit_dept FOREIGN KEY (department_id) REFERENCES departments(department_id)  -- Corrected table name
);

 ----7.Dailytracker
CREATE TABLE daily_tracker (
    tracker_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    tracker_date DATE NOT NULL,
    department_id NUMBER NOT NULL,
    patient_count NUMBER DEFAULT 0 CHECK (patient_count >= 0),
    created_on DATE DEFAULT SYSDATE NOT NULL,
    created_by NUMBER,
    
    CONSTRAINT uq_tracker_date_dept UNIQUE (tracker_date, department_id),
    CONSTRAINT fk_tracker_dept FOREIGN KEY (department_id)
    REFERENCES departments(department_id)
);
CREATE TABLE system_error_log (
    log_id          NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    error_message   VARCHAR2(4000),
    module_name     VARCHAR2(100),
    operation_type  VARCHAR2(50),
    error_date      DATE DEFAULT SYSDATE
);
CREATE TABLE public_holidays (
    holiday_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    holiday_date DATE NOT NULL UNIQUE,
    description VARCHAR2(100)
);
CREATE TABLE hospital_audit_log (
    audit_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_name VARCHAR2(50),
    action_type VARCHAR2(10),
    table_name VARCHAR2(40),
    action_date DATE DEFAULT SYSDATE,
    record_id NUMBER
);


## DML

** DATA INSERTION **

---1.Insert sample departments (manual, realistic)----------

 INSERT INTO departments (dept_code, dept_name)
 VALUES ('GEN', 'General Medicine');
 
 INSERT INTO departments (dept_code, dept_name)
 VALUES ('PED', 'Pediatrics');
 
 INSERT INTO departments (dept_code, dept_name)
 VALUES ('GYN', 'Gynecology');
 
 INSERT INTO departments (dept_code, dept_name)
 VALUES ('SUR', 'Surgery');
 
 INSERT INTO departments (dept_code, dept_name)
 VALUES ('EMR', 'Emergency');
 
 
  ---2.Insert realistic staff/users-------------

INSERT INTO users_staff (username, full_name, role, email) 
VALUES ('admin01', 'System Administration', 'ADMIN', 'admin@gmail.com');

INSERT INTO users_staff (username, full_name, role, email) 
VALUES ('nurse_jane', 'Jane Uwase', 'NURSE', 'jane@gmail.com');

 INSERT INTO users_staff (username, full_name, role, email)
 VALUES ('doc_paul', 'Dr.Paul Kalisa', 'DOCTOR', 'paul@gmail.com');

 ---4.insert doctors(manual + consistent)-----

 INSERT INTO doctors (doctor_code, full_name, department_id, phone, email)
 VALUES ('DOC100', 'Dr.Paul Kalisa', 1, '0788232345', 'paul@gmail.com');
 
 INSERT INTO doctors (doctor_code, full_name, department_id, phone, email)
 VALUES ('DOC200', 'Dr.Alice Murekatete', 2, '0788687898', 'alice@gmail.com');
 
 INSERT INTO doctors (doctor_code, full_name, department_id, phone, email)
 VALUES ('DOC300', 'Dr.Jean Claude', 5, '0788212223', 'claude@gmail.com');

-------PUBLIC_DOCTORS-----------------

INSERT INTO public_holidays (holiday_date, description)
VALUES (TO_DATE('2025-12-25', 'YYYY-MM-DD'), 'Christmas Day');

INSERT INTO public_holidays (holiday_date, description)
VALUES (TO_DATE('2025-01-01', 'YYYY-MM-DD'), 'New year');

INSERT INTO public_holidays (holiday_date, description)
VALUES (TO_DATE('2025-04-18', 'YYYY-MM-DD'), 'Good Friday');

INSERT INTO public_holidays (holiday_date, description)
VALUES (TO_DATE('2025-04-21', 'YYYY-MM-DD'), 'Easter Monday');

COMMIT;
-----AUDIT_LOG---- 
INSERT INTO hospital_audit_log (user_name, action_type, table_name, record_id)
VALUES ('jteta04', 'INSERT', 'PATIENTS', 101);

INSERT INTO hospital_audit_log (user_name, action_type, table_name, record_id)
VALUES ('julie0', 'UPDATE', 'DOCTORS', 5);

INSERT INTO hospital_audit_log (user_name, action_type, table_name, record_id)
VALUES ('tetaj', 'DELETE', 'APPOINTMENT', 12);

INSERT INTO hospital_audit_log (user_name, action_type, table_name, record_id)
VALUES ('tjulie', 'INSERT', 'DAILY_TRACKER', 201);

INSERT INTO hospital_audit_log (user_name, action_type, table_name, record_id)
VALUES ('tjay', 'UPDATE', 'PATIENTS', 102);

## Advanced Implementation

**Appointment_Analytics Package**

The Appointment Analytics package analyzes patient appointment data to help the hospital or clinic optimize scheduling. It calculates appointment trends,
identifies peak hours, monitors cancellations or no-shows,
and can alert staff when adjustments are needed to improve efficiency and patient flow.

** CODES**

-----1. ALL PROCEDURES WITH PARAMETERS-------
-----PATIENT MANAGEMENT PROCEDURES-------
-- Add a new patient
PROCEDURE add_patient (
    p_patient_id   IN OUT NUMBER,
    p_first_name   IN VARCHAR2,
    p_last_name    IN VARCHAR2,
    p_gender       IN VARCHAR2,
    p_phone        IN VARCHAR2,
    p_message      OUT VARCHAR2
);

-- Bulk insert daily visits
PROCEDURE bulk_insert_daily_visits;

-----APPOINTMENT MANAGEMENT PROCEDURES-----
-- Schedule an appointment
PROCEDURE schedule_appointment (
    p_patient_id   IN NUMBER,
    p_doctor_id    IN NUMBER,
    p_date         IN DATE,
    p_notes        IN VARCHAR2,
    p_status       OUT VARCHAR2
);

-- Update appointment status
PROCEDURE update_appointment_status (
    p_appointment_id IN NUMBER,
    p_new_status     IN VARCHAR2,
    p_feedback       OUT VARCHAR2
);

------AUDIT LOGGING PROCEDURE-----
-- Centralized procedure to log actions
CREATE OR REPLACE PROCEDURE log_hospital_audit (
    p_action      VARCHAR2,
    p_table_name  VARCHAR2,
    p_record_id   VARCHAR2
);

------2. ALL FUNCTIONS WITH RETURN TYPES--------
-- Get patient age
FUNCTION get_patient_age (
    p_patient_id IN NUMBER
) RETURN NUMBER;

-- Check if doctor exists
FUNCTION doctor_exists (
    p_doctor_id IN NUMBER
) RETURN NUMBER;

-- Count patient appointments
FUNCTION count_patient_appointments (
    p_patient_id IN NUMBER
) RETURN NUMBER;

-- Validate if hospital data modification is allowed
FUNCTION hospital_restriction_check
RETURN BOOLEAN;

--------3. ALL TRIGGERS WITH LOGIC EXPLANATION-----
-----SIMPLE TRIGGERS-----------
-- trg_appointments_restrict_hospital
-- Purpose: Prevents restricted operations on appointments & logs actions
CREATE OR REPLACE TRIGGER trg_appointments_restrict_hospital
BEFORE INSERT OR UPDATE OR DELETE ON appointments
FOR EACH ROW
BEGIN
    IF NOT hospital_restriction_check THEN
        RAISE_APPLICATION_ERROR(
            -20001,
            'Data modification is not allowed today in the Patient Appointment & Daily Tracker System'
        );
    END IF;

    IF INSERTING THEN
        log_hospital_audit('INSERT', 'APPOINTMENTS', :NEW.appointment_id);
    ELSIF UPDATING THEN
        log_hospital_audit('UPDATE', 'APPOINTMENTS', :NEW.appointment_id);
    ELSIF DELETING THEN
        log_hospital_audit('DELETE', 'APPOINTMENTS', :OLD.appointment_id);
    END IF;
END;

---------COUMPOUND TRIGGER------
-- trg_patients_compound_hospital
-- Purpose: Enforces restrictions & audits for bulk operations on patients table
CREATE OR REPLACE TRIGGER trg_patients_compound_hospital
FOR INSERT OR UPDATE OR DELETE ON patients
COMPOUND TRIGGER

    BEFORE STATEMENT IS
    BEGIN
        IF NOT hospital_restriction_check THEN
            RAISE_APPLICATION_ERROR(
                -20002,
                'Operation blocked by Patient Appointment & Daily Tracker System rules'
            );
        END IF;
    END BEFORE STATEMENT;

    AFTER EACH ROW IS
    BEGIN
        IF INSERTING THEN
            log_hospital_audit('INSERT', 'PATIENTS', :NEW.patient_id);
        ELSIF UPDATING THEN
            log_hospital_audit('UPDATE', 'PATIENTS', :NEW.patient_id);
        ELSIF DELETING THEN
            log_hospital_audit('DELETE', 'PATIENTS', :OLD.patient_id);
        END IF;
    END AFTER EACH ROW;

END trg_patients_compound_hospital;

----------4. PACKAGES (SPECIALIZATION &BODY)---------
----PACKAGE SPECIFICATION--------
CREATE OR REPLACE PACKAGE hospital_mgmt_pkg IS

    -- Patient Management
    PROCEDURE add_patient(
        p_patient_id IN OUT NUMBER,
        p_first_name IN VARCHAR2,
        p_last_name  IN VARCHAR2,
        p_gender     IN VARCHAR2,
        p_phone      IN VARCHAR2,
        p_message    OUT VARCHAR2
    );

    -- Appointment Management
    PROCEDURE schedule_appointment(
        p_patient_id IN NUMBER,
        p_doctor_id  IN NUMBER,
        p_date       IN DATE,
        p_notes     IN VARCHAR2,
        p_status    OUT VARCHAR2
    );

    PROCEDURE update_appointment_status(
        p_appointment_id IN NUMBER,
        p_new_status     IN VARCHAR2,
        p_feedback       OUT VARCHAR2
    );

    -- Utility Functions
    FUNCTION get_patient_age(p_patient_id IN NUMBER) RETURN NUMBER;
    FUNCTION doctor_exists(p_doctor_id IN NUMBER) RETURN NUMBER;
    FUNCTION count_patient_appointments(p_patient_id IN NUMBER) RETURN NUMBER;

    -- Bulk insert daily visits
    PROCEDURE bulk_insert_daily_visits;

END hospital_mgmt_pkg;

--------PACKAGE BODY--------
CREATE OR REPLACE PACKAGE BODY hospital_mgmt_pkg IS

    -- Add patient
    PROCEDURE add_patient(...) AS BEGIN ... END;

    -- Get patient age
    FUNCTION get_patient_age(...) RETURN NUMBER IS BEGIN ... END;

    -- Count patient appointments
    FUNCTION count_patient_appointments(...) RETURN NUMBER IS BEGIN ... END;

    -- Check doctor existence
    FUNCTION doctor_exists(...) RETURN NUMBER IS BEGIN ... END;

    -- Schedule appointment
    PROCEDURE schedule_appointment(...) AS BEGIN ... END;

    -- Update appointment status
    PROCEDURE update_appointment_status(...) AS BEGIN ... END;

    -- Bulk insert daily visits
    PROCEDURE bulk_insert_daily_visits AS BEGIN ... END;

END hospital_mgmt_pkg;


-------5.Analytics Queries (Aggregations & Window Functions)--------
------DAILY VISIT COUNT--------
SELECT visit_date, COUNT(visit_id) AS daily_visit_count
FROM visits
GROUP BY visit_date
ORDER BY visit_date DESC;

------CONFLICT CHECKING (DOUBLE BOOKING)---
SELECT COUNT(*) AS conflicts
FROM appointments
WHERE doctor_id = 2
  AND appointment_date = TO_DATE('2025-12-12', 'YYYY-MM-DD')
  AND TO_TIMESTAMP('10:00 AM', 'HH:MI AM') BETWEEN appointment_date AND appointment_date + INTERVAL '1' HOUR;

--------EDGE CASE CHECKS----------
-- Double Booking
SELECT appointment_id
FROM appointments
WHERE doctor_id = :DOC200
  AND appointment_date = TO_DATE(:appointment_date, '2022-12-01')
  AND TO_TIMESTAMP(:appointment_time, '12:12 AM') BETWEEN appointment_date AND appointment_date + INTERVAL '1' HOUR;

-- Invalid Patient (FK)
SELECT patient_id
FROM patients
WHERE patient_id = :1;

-- Constraint violation
SELECT appointment_no
FROM appointments
WHERE status NOT IN ('SCHEDULED', 'COMPLETED', 'CANCELLED');

-- Unique constraint violation
SELECT COUNT(*)
FROM appointments
WHERE patient_id = :2
  AND doctor_id = :DOC200
  AND appointment_date = TO_DATE(:appointment_date, '2020-12-12')
  AND TO_TIMESTAMP(:appointment_time, '12:00 AM') BETWEEN appointment_date AND appointment_date + INTERVAL '1' HOUR;




