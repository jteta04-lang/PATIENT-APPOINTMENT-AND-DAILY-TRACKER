## DDL

** CREATING TABLES **

---- TABLE CREATION----
  ---1.departments
CREATE TABLE DEPARTMENTS (
department_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
dept_code VARCHAR2(10) NOT NULL UNIQUE,
dept_name VARCHAR2(100) NOT NULL,
active    CHAR(1) DEFAULT 'Y' CHECK (active IN ('Y','N'))
);

  ---2.users/staff
CREATE TABLE users_staff (
    staff_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username VARCHAR2(50) NOT NULL UNIQUE,
    full_name VARCHAR(100) NOT NULL,
    role VARCHAR(50) DEFAULT 'CLERK' CHECK (role IN ('ADMIN','DOCTOR','NURSE','CLERK','RECEPTION')),
    email VARCHAR(100),
    created_on DATE DEFAULT SYSDATE NOT NULL
);

  ---3.Patients
CREATE TABLE patients (
    patient_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    national_id VARCHAR2(20) UNIQUE,
    first_name VARCHAR(20) NOT NULL,
    last_name VARCHAR(20) NOT NULL,
    gender VARCHAR(10) DEFAULT 'OTHER' 
        CHECK (gender IN ('M','F','OTHER')),
    date_of_birth DATE,
    phone VARCHAR2(20),
    email VARCHAR2(100),
    address VARCHAR2(200),
    created_on DATE DEFAULT SYSDATE NOT NULL
);

ALTER TABLE patients
ADD last_visit DATE;


 ---4.Doctors
CREATE TABLE doctors (
    doctor_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    doctor_code VARCHAR2(20) NOT NULL UNIQUE,
    full_name VARCHAR(120) NOT NULL,
    department_id NUMBER NOT NULL,
    phone VARCHAR2(20),
    email VARCHAR2(100),
    active CHAR(1) DEFAULT 'Y' CHECK (active IN ('Y','N')),
    
    CONSTRAINT fk_doctor_dept FOREIGN KEY (department_id)
    REFERENCES departments(department_id)
);

ALTER TABLE doctors
ADD (
    first_name VARCHAR2(50),
    last_name VARCHAR2(50)
);


  ---5.Appointments
CREATE TABLE appointments (
    appointment_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    appointment_no VARCHAR2(50) NOT NULL,  -- You need to define a length for VARCHAR2
    patient_id NUMBER NOT NULL,
    doctor_id NUMBER NOT NULL,
    department_id NUMBER NOT NULL,
    appointment_date DATE NOT NULL,
    appointment_time VARCHAR2(10),
    status VARCHAR2(20) DEFAULT 'SCHEDULED'
        CHECK (status IN ('SCHEDULED', 'COMPLETED', 'CANCELLED', 'NO_SHOW')),
    reason VARCHAR2(4000),  -- Ensure this is the intended size
    created_by NUMBER,
    created_on DATE DEFAULT SYSDATE NOT NULL,
    
    CONSTRAINT fk_appt_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id),
    CONSTRAINT fk_appt_doctor FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id),
    CONSTRAINT fk_appt_dept FOREIGN KEY (department_id) REFERENCES departments(department_id)
);

 ---6.Visits(daily log)
 CREATE TABLE visits (
    visit_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    visit_no VARCHAR2(30) NOT NULL UNIQUE,  -- Corrected data type (VARCHAR2)
    patient_id NUMBER NOT NULL,
    doctor_id NUMBER,
    department_id NUMBER NOT NULL,
    visit_date DATE NOT NULL,
    visit_time VARCHAR2(10),
    visit_type VARCHAR2(20) DEFAULT 'OUTPATIENT'
        CHECK (visit_type IN ('OUTPATIENT', 'INPATIENT', 'EMERGENCY')),
    visit_status VARCHAR2(20) DEFAULT 'ATTENDED'
        CHECK (visit_status IN ('ATTENDED', 'LEFT', 'REFERRED', 'DIED')),
    notes VARCHAR2(4000),
    registered_by NUMBER,
    registered_on DATE DEFAULT SYSDATE NOT NULL,
    
    CONSTRAINT fk_visit_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id),
    CONSTRAINT fk_visit_doctor FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id),  -- Corrected table name
    CONSTRAINT fk_visit_dept FOREIGN KEY (department_id) REFERENCES departments(department_id)  -- Corrected table name
);

 ----7.Dailytracker
CREATE TABLE daily_tracker (
    tracker_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    tracker_date DATE NOT NULL,
    department_id NUMBER NOT NULL,
    patient_count NUMBER DEFAULT 0 CHECK (patient_count >= 0),
    created_on DATE DEFAULT SYSDATE NOT NULL,
    created_by NUMBER,
    
    CONSTRAINT uq_tracker_date_dept UNIQUE (tracker_date, department_id),
    CONSTRAINT fk_tracker_dept FOREIGN KEY (department_id)
    REFERENCES departments(department_id)
);
CREATE TABLE system_error_log (
    log_id          NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    error_message   VARCHAR2(4000),
    module_name     VARCHAR2(100),
    operation_type  VARCHAR2(50),
    error_date      DATE DEFAULT SYSDATE
);
CREATE TABLE public_holidays (
    holiday_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    holiday_date DATE NOT NULL UNIQUE,
    description VARCHAR2(100)
);
CREATE TABLE hospital_audit_log (
    audit_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_name VARCHAR2(50),
    action_type VARCHAR2(10),
    table_name VARCHAR2(40),
    action_date DATE DEFAULT SYSDATE,
    record_id NUMBER
);


## DML

** DATA INSERTION **

---1.Insert sample departments (manual, realistic)----------

 INSERT INTO departments (dept_code, dept_name)
 VALUES ('GEN', 'General Medicine');
 
 INSERT INTO departments (dept_code, dept_name)
 VALUES ('PED', 'Pediatrics');
 
 INSERT INTO departments (dept_code, dept_name)
 VALUES ('GYN', 'Gynecology');
 
 INSERT INTO departments (dept_code, dept_name)
 VALUES ('SUR', 'Surgery');
 
 INSERT INTO departments (dept_code, dept_name)
 VALUES ('EMR', 'Emergency');
 
 
  ---2.Insert realistic staff/users-------------

INSERT INTO users_staff (username, full_name, role, email) 
VALUES ('admin01', 'System Administration', 'ADMIN', 'admin@gmail.com');

INSERT INTO users_staff (username, full_name, role, email) 
VALUES ('nurse_jane', 'Jane Uwase', 'NURSE', 'jane@gmail.com');

 INSERT INTO users_staff (username, full_name, role, email)
 VALUES ('doc_paul', 'Dr.Paul Kalisa', 'DOCTOR', 'paul@gmail.com');

 ---4.insert doctors(manual + consistent)-----

 INSERT INTO doctors (doctor_code, full_name, department_id, phone, email)
 VALUES ('DOC100', 'Dr.Paul Kalisa', 1, '0788232345', 'paul@gmail.com');
 
 INSERT INTO doctors (doctor_code, full_name, department_id, phone, email)
 VALUES ('DOC200', 'Dr.Alice Murekatete', 2, '0788687898', 'alice@gmail.com');
 
 INSERT INTO doctors (doctor_code, full_name, department_id, phone, email)
 VALUES ('DOC300', 'Dr.Jean Claude', 5, '0788212223', 'claude@gmail.com');

-------PUBLIC_DOCTORS-----------------

INSERT INTO public_holidays (holiday_date, description)
VALUES (TO_DATE('2025-12-25', 'YYYY-MM-DD'), 'Christmas Day');

INSERT INTO public_holidays (holiday_date, description)
VALUES (TO_DATE('2025-01-01', 'YYYY-MM-DD'), 'New year');

INSERT INTO public_holidays (holiday_date, description)
VALUES (TO_DATE('2025-04-18', 'YYYY-MM-DD'), 'Good Friday');

INSERT INTO public_holidays (holiday_date, description)
VALUES (TO_DATE('2025-04-21', 'YYYY-MM-DD'), 'Easter Monday');

COMMIT;
-----AUDIT_LOG---- 
INSERT INTO hospital_audit_log (user_name, action_type, table_name, record_id)
VALUES ('jteta04', 'INSERT', 'PATIENTS', 101);

INSERT INTO hospital_audit_log (user_name, action_type, table_name, record_id)
VALUES ('julie0', 'UPDATE', 'DOCTORS', 5);

INSERT INTO hospital_audit_log (user_name, action_type, table_name, record_id)
VALUES ('tetaj', 'DELETE', 'APPOINTMENT', 12);

INSERT INTO hospital_audit_log (user_name, action_type, table_name, record_id)
VALUES ('tjulie', 'INSERT', 'DAILY_TRACKER', 201);

INSERT INTO hospital_audit_log (user_name, action_type, table_name, record_id)
VALUES ('tjay', 'UPDATE', 'PATIENTS', 102);

## Advanced Implementation

**Appointment_Analytics Package**

The Appointment Analytics package analyzes patient appointment data to help the hospital or clinic optimize scheduling. It calculates appointment trends,
identifies peak hours, monitors cancellations or no-shows,
and can alert staff when adjustments are needed to improve efficiency and patient flow.

** CODES**

-- First, disable any existing triggers that might interfere
BEGIN
    EXECUTE IMMEDIATE 'ALTER TRIGGER trg_appointments_restrict_hospital DISABLE';
    EXECUTE IMMEDIATE 'ALTER TRIGGER trg_patients_compound_hospital DISABLE';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

-- DATABASE INTERACTION AND TRANSACTION---
-- Procedure 1: add new patient (insert + in out parameter)
CREATE OR REPLACE PROCEDURE add_patient (
  p_patient_id IN OUT NUMBER,
  p_first_name IN VARCHAR2,
  p_last_name IN VARCHAR2,
  p_gender IN VARCHAR2,
  p_phone IN VARCHAR2,
  p_message OUT VARCHAR2
) AS
BEGIN
  -- If the patient_id is not provided, generate a new one
  IF p_patient_id IS NULL THEN
    SELECT patients_seq.NEXTVAL INTO p_patient_id FROM dual;
  END IF;

  -- Check if the phone number already exists
  DECLARE
    v_exists NUMBER;
  BEGIN
    SELECT COUNT(*)
    INTO v_exists
    FROM patients
    WHERE phone = p_phone;

    IF v_exists > 0 THEN
      p_message := 'Error: Duplicate phone number. Please provide a unique phone number.';
      RETURN;
    END IF;
  END;

  -- Insert new patient record
  INSERT INTO patients (patient_id, first_name, last_name, gender, phone)
  VALUES (p_patient_id, p_first_name, p_last_name, p_gender, p_phone);

  -- Success message
  p_message := 'Patient added successfully with ID: ' || p_patient_id;

EXCEPTION
  WHEN OTHERS THEN
    -- Handle unexpected errors
    p_message := 'Unexpected error: ' || SQLERRM;
END;
/

-- Procedure 2: schedule appointment (insert + exception handling)
CREATE OR REPLACE PROCEDURE SCHEDULE_APPOINTMENT (
    p_appointment_id IN OUT NUMBER,
    p_patient_id IN NUMBER,
    p_doctor_id IN NUMBER,
    p_appointment_date IN DATE,
    p_message OUT VARCHAR2
) AS
BEGIN
    -- If the appointment ID is NULL, generate a new one
    IF p_appointment_id IS NULL THEN
        SELECT appointments_seq.NEXTVAL INTO p_appointment_id FROM dual;
    END IF;

    -- Insert the appointment record
    INSERT INTO appointments (appointment_id, patient_id, doctor_id, appointment_date)
    VALUES (p_appointment_id, p_patient_id, p_doctor_id, p_appointment_date);

    -- Success message
    p_message := 'Appointment scheduled successfully with ID ' || p_appointment_id;

EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        p_message := 'Error: Duplicate appointment ID or data exists.';
    WHEN OTHERS THEN
        p_message := 'Unexpected error: ' || SQLERRM;
END;
/

-- Procedure 3: update appointment status (update + IN parameter)
CREATE OR REPLACE PROCEDURE update_appointment_status (
    p_appointment_id IN NUMBER,
    p_new_status IN VARCHAR2,
    p_feedback OUT VARCHAR2
) AS
BEGIN
    UPDATE appointments
    SET status = p_new_status
    WHERE appointment_id = p_appointment_id;

    IF SQL%ROWCOUNT = 0 THEN
        p_feedback := 'No appointment found with the given ID.';
    ELSE
        p_feedback := 'Appointment updated successfully.';
    END IF;

EXCEPTION
    WHEN OTHERS THEN
        p_feedback := 'Error occurred: ' || SQLERRM;
END;
/

-- Procedure 4: delete patient (delete + cascade rule testing)
CREATE OR REPLACE PROCEDURE delete_patient (
    p_patient_id IN NUMBER,
    p_result OUT VARCHAR2
) AS
    v_count NUMBER;
BEGIN
    SELECT COUNT(*)
    INTO v_count
    FROM appointments
    WHERE patient_id = p_patient_id;

    IF v_count > 0 THEN
        p_result := 'Cannot delete patient. Existing appointments found.';
        RETURN;
    END IF;

    DELETE FROM patients WHERE patient_id = p_patient_id;

    IF SQL%ROWCOUNT = 0 THEN
        p_result := 'Patient not found.';
    ELSE
        p_result := 'Patient deleted successfully.';
    END IF;

EXCEPTION
    WHEN OTHERS THEN
        p_result := 'Error: ' || SQLERRM;
END;
/

-- Procedure 5: count daily patient visits (aggregation + OUT parameter)
CREATE OR REPLACE PROCEDURE daily_visit_count (
    p_date IN DATE,
    p_total OUT NUMBER
) AS
BEGIN
    SELECT COUNT(*)
    INTO p_total
    FROM appointments
    WHERE TRUNC(appointment_date) = TRUNC(p_date);

EXCEPTION
    WHEN OTHERS THEN
        p_total := -1; -- indicates an error
END;
/

------ FUNCTIONS----
-- 1. calculate patient age
CREATE OR REPLACE FUNCTION get_patient_age (
    p_patient_id IN NUMBER
) RETURN NUMBER
IS
    v_age NUMBER;
BEGIN
    SELECT TRUNC(MONTHS_BETWEEN(SYSDATE, date_of_birth) / 12)
    INTO v_age
    FROM patients
    WHERE patient_id = p_patient_id;

    RETURN v_age;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN -1;  -- patient not found
    WHEN OTHERS THEN
        RETURN -2;  -- unexpected error
END;
/

-- 2. VALIDATE PHONE NUMBER FORMAT (VALIDATION)
CREATE OR REPLACE FUNCTION validate_phone (
    p_phone IN VARCHAR2
) RETURN NUMBER
IS
BEGIN
    IF REGEXP_LIKE(p_phone, '^[0-9]{10,13}$') THEN
        RETURN 1;
    ELSE
        RETURN 0;
    END IF;
END;
/

-- 3. CHECK IF DOCTOR EXISTS
CREATE OR REPLACE FUNCTION doctor_exists (
    p_doctor_id IN NUMBER
) RETURN NUMBER
IS
    v_count NUMBER := 0;
BEGIN
    SELECT COUNT(*) INTO v_count
    FROM doctors
    WHERE doctor_id = p_doctor_id;

    IF v_count > 0 THEN
        RETURN 1;
    ELSE
        RETURN 0;
    END IF;

EXCEPTION
    WHEN OTHERS THEN
        RETURN -1;  -- unexpected error
END;
/

-- 4. COUNT APPOINTMENTS FOR A PATIENT
CREATE OR REPLACE FUNCTION count_patient_appointments (
    p_patient_id IN NUMBER
) RETURN NUMBER
IS
    v_total NUMBER := 0;
BEGIN
    SELECT COUNT(*) INTO v_total
    FROM appointments
    WHERE patient_id = p_patient_id;

    RETURN v_total;

EXCEPTION
    WHEN OTHERS THEN
        RETURN -1;
END;
/

-- 5. GET DOCTOR NAME BY ID
CREATE OR REPLACE FUNCTION get_doctor_name (
    p_doctor_id IN NUMBER
) RETURN VARCHAR2
IS
    v_name VARCHAR2(200);
BEGIN
    SELECT first_name || ' ' || last_name
    INTO v_name
    FROM doctors
    WHERE doctor_id = p_doctor_id;

    RETURN v_name;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 'DOCTOR NOT FOUND';
    WHEN OTHERS THEN
        RETURN 'ERROR';
END;
/

-- EXPLICIT CURSOR: LIST ALL PATIENTS WITH MORE THAN 3 APPOINTMENTS
CREATE OR REPLACE PROCEDURE list_frequent_patients
AS
    CURSOR c_patients IS
        SELECT p.patient_id, p.first_name, p.last_name,
               COUNT(a.appointment_id) AS total_visits
        FROM patients p
        JOIN appointments a ON p.patient_id = a.patient_id
        GROUP BY p.patient_id, p.first_name, p.last_name
        HAVING COUNT(a.appointment_id) > 3;

    v_id   patients.patient_id%TYPE;
    v_fn   patients.first_name%TYPE;
    v_ln   patients.last_name%TYPE;
    v_count NUMBER;
BEGIN
    OPEN c_patients;

    LOOP
        FETCH c_patients INTO v_id, v_fn, v_ln, v_count;
        EXIT WHEN c_patients%NOTFOUND;

        DBMS_OUTPUT.PUT_LINE(
            'Patient: ' || v_fn || ' ' || v_ln ||
            ' | Total Visits: ' || v_count
        );
    END LOOP;

    CLOSE c_patients;
END;
/

-- CURSOR FOR LOOP: LIST ALL DOCTORS WITH NUMBER OF PATIENTS
CREATE OR REPLACE PROCEDURE doctor_visit_summary
AS
    CURSOR c_doctors IS
        SELECT d.doctor_id,
               d.first_name || ' ' || d.last_name AS doctor_name,
               COUNT(a.appointment_id) AS total_appointments
        FROM doctors d
        LEFT JOIN appointments a ON d.doctor_id = a.doctor_id
        GROUP BY d.doctor_id, d.first_name, d.last_name;
BEGIN
    FOR doc IN c_doctors LOOP
        DBMS_OUTPUT.PUT_LINE(
            'Doctor: ' || doc.doctor_name ||
            ' | Appointments: ' || doc.total_appointments
        );
    END LOOP;
END;
/

-- BULK COLLECT CURSOR: LOAD ALL PATIENTS IDs
CREATE OR REPLACE PROCEDURE bulk_load_patients
AS
    TYPE patient_list IS TABLE OF NUMBER;
    v_patients patient_list;
BEGIN
    SELECT patient_id BULK COLLECT INTO v_patients
    FROM patients;

    DBMS_OUTPUT.PUT_LINE('Loaded ' || v_patients.COUNT || ' patients in memory.');
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/

-- BULK INSERT USING FORALL
CREATE OR REPLACE PROCEDURE bulk_insert_daily_visits
AS
    TYPE visit_rec IS RECORD (
        patient_id NUMBER,
        doctor_id  NUMBER,
        visit_date DATE
    );

    TYPE visit_table IS TABLE OF visit_rec;
    v_visits visit_table := visit_table();
BEGIN
    -- Add sample entries
    v_visits.EXTEND(3);
    v_visits(1) := visit_rec(101, 5, SYSDATE);
    v_visits(2) := visit_rec(102, 3, SYSDATE);
    v_visits(3) := visit_rec(110, 4, SYSDATE);

    -- Bulk insert into APPOINTMENTS
    FORALL i IN 1 .. v_visits.COUNT
        INSERT INTO appointments (
            appointment_id,
            patient_id,
            doctor_id,
            appointment_date,
            reason
        ) VALUES (
            appointments_seq.NEXTVAL,
            v_visits(i).patient_id,
            v_visits(i).doctor_id,
            v_visits(i).visit_date,
            'BULK INSERT'
        );

    DBMS_OUTPUT.PUT_LINE('Bulk insert completed: ' || v_visits.COUNT || ' records');
END;
/

-- WINDOW FUNCTIONS
-- Note: These are SELECT statements, not procedures/functions

-- PACKAGE SPECIALIZATION
CREATE OR REPLACE PACKAGE hospital_mgmt_pkg IS
    ---------------------------------------
    -- PATIENT MANAGEMENT
    ---------------------------------------
    PROCEDURE add_patient (
        p_patient_id   IN OUT NUMBER,
        p_first_name   IN VARCHAR2,
        p_last_name    IN VARCHAR2,
        p_gender       IN VARCHAR2,
        p_phone        IN VARCHAR2,
        p_message      OUT VARCHAR2
    );

    ---------------------------------------
    -- APPOINTMENT MANAGEMENT
    ---------------------------------------
    PROCEDURE schedule_appointment (
        p_patient_id   IN NUMBER,
        p_doctor_id    IN NUMBER,
        p_date         IN DATE,
        p_notes        IN VARCHAR2,
        p_status       OUT VARCHAR2
    );

    PROCEDURE update_appointment_status (
        p_appointment_id IN NUMBER,
        p_new_status     IN VARCHAR2,
        p_feedback       OUT VARCHAR2
    );

    ---------------------------------------
    -- UTILITY FUNCTIONS
    ---------------------------------------
    FUNCTION get_patient_age (
        p_patient_id IN NUMBER
    ) RETURN NUMBER;

    FUNCTION doctor_exists (
        p_doctor_id IN NUMBER
    ) RETURN NUMBER;

    FUNCTION count_patient_appointments (
        p_patient_id IN NUMBER
    ) RETURN NUMBER;

    ---------------------------------------
    -- BULK OPERATIONS
    ---------------------------------------
    PROCEDURE bulk_insert_daily_visits;

END hospital_mgmt_pkg;
/

-- PACKAGE BODY (IMPLEMENTATION)
CREATE OR REPLACE PACKAGE BODY hospital_mgmt_pkg IS

    -----------------------------------------------------------
    -- 1. PATIENT MANAGEMENT
    -----------------------------------------------------------

    -- Add a new patient
    PROCEDURE add_patient (
        p_patient_id   IN OUT NUMBER,
        p_first_name   IN VARCHAR2,
        p_last_name    IN VARCHAR2,
        p_gender       IN VARCHAR2,
        p_phone        IN VARCHAR2,
        p_message      OUT VARCHAR2
    ) AS
        v_exists NUMBER;
    BEGIN
        -- If patient_id is provided, use it; otherwise generate new
        IF p_patient_id IS NULL THEN
            SELECT patients_seq.NEXTVAL INTO p_patient_id FROM dual;
        END IF;

        -- Check for duplicate phone
        SELECT COUNT(*)
        INTO v_exists
        FROM patients
        WHERE phone = p_phone;

        IF v_exists > 0 THEN
            p_message := 'Error: Duplicate phone number.';
            RETURN;
        END IF;

        -- Insert patient
        INSERT INTO patients (patient_id, first_name, last_name, gender, phone)
        VALUES (p_patient_id, p_first_name, p_last_name, p_gender, p_phone);

        p_message := 'Patient ' || p_first_name || ' added successfully with ID: ' || p_patient_id;
    EXCEPTION
        WHEN DUP_VAL_ON_INDEX THEN
            p_message := 'Duplicate patient or phone number.';
        WHEN OTHERS THEN
            p_message := 'Error: ' || SQLERRM;
    END add_patient;

    -- Get patient age
    FUNCTION get_patient_age (
        p_patient_id IN NUMBER
    ) RETURN NUMBER IS
        v_age NUMBER;
    BEGIN
        SELECT TRUNC(MONTHS_BETWEEN(SYSDATE, date_of_birth) / 12)
        INTO v_age
        FROM patients
        WHERE patient_id = p_patient_id;

        RETURN v_age;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RETURN -1;
        WHEN OTHERS THEN
            RETURN -2;
    END get_patient_age;

    -- Count appointments for a patient
    FUNCTION count_patient_appointments (
        p_patient_id IN NUMBER
    ) RETURN NUMBER IS
        v_total NUMBER;
    BEGIN
        SELECT COUNT(*) INTO v_total FROM appointments WHERE patient_id = p_patient_id;
        RETURN v_total;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN -1;
    END count_patient_appointments;

    -----------------------------------------------------------
    -- 2. DOCTOR MANAGEMENT
    -----------------------------------------------------------

    -- Check if doctor exists
    FUNCTION doctor_exists (
        p_doctor_id IN NUMBER
    ) RETURN NUMBER IS
        v_count NUMBER;
    BEGIN
        SELECT COUNT(*) INTO v_count FROM doctors WHERE doctor_id = p_doctor_id;
        RETURN CASE WHEN v_count > 0 THEN 1 ELSE 0 END;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN -1;
    END doctor_exists;

    -----------------------------------------------------------
    -- 3. APPOINTMENT MANAGEMENT
    -----------------------------------------------------------

    -- Schedule an appointment
    PROCEDURE schedule_appointment (
        p_patient_id   IN NUMBER,
        p_doctor_id    IN NUMBER,
        p_date         IN DATE,
        p_notes        IN VARCHAR2,
        p_status       OUT VARCHAR2
    ) AS
        v_appointment_id NUMBER;
    BEGIN
        SELECT appointments_seq.NEXTVAL INTO v_appointment_id FROM dual;
        
        INSERT INTO appointments (appointment_id, patient_id, doctor_id, appointment_date, reason)
        VALUES (v_appointment_id, p_patient_id, p_doctor_id, p_date, p_notes);

        p_status := 'Appointment booked successfully with ID: ' || v_appointment_id;
    EXCEPTION
        WHEN OTHERS THEN
            p_status := 'Error: ' || SQLERRM;
    END schedule_appointment;

    -- Update appointment status
    PROCEDURE update_appointment_status (
        p_appointment_id IN NUMBER,
        p_new_status     IN VARCHAR2,
        p_feedback       OUT VARCHAR2
    ) AS
    BEGIN
        UPDATE appointments
        SET status = p_new_status
        WHERE appointment_id = p_appointment_id;

        IF SQL%ROWCOUNT = 0 THEN
            p_feedback := 'Appointment not found.';
        ELSE
            p_feedback := 'Status updated successfully.';
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            p_feedback := 'Error: ' || SQLERRM;
    END update_appointment_status;

    -- Bulk insert daily visits
    PROCEDURE bulk_insert_daily_visits AS
        TYPE visit_rec IS RECORD (
            patient_id NUMBER,
            doctor_id  NUMBER,
            visit_date DATE
        );
        TYPE visit_table IS TABLE OF visit_rec;
        v_visits visit_table := visit_table();
    BEGIN
        v_visits.EXTEND(3);
        v_visits(1) := visit_rec(101, 5, SYSDATE);
        v_visits(2) := visit_rec(102, 3, SYSDATE);
        v_visits(3) := visit_rec(110, 4, SYSDATE);

        FORALL i IN 1..v_visits.COUNT
            INSERT INTO appointments (appointment_id, patient_id, doctor_id, appointment_date, reason)
            VALUES (appointments_seq.NEXTVAL, v_visits(i).patient_id, v_visits(i).doctor_id, v_visits(i).visit_date, 'BULK INSERT');

        DBMS_OUTPUT.PUT_LINE('Bulk insert completed: ' || v_visits.COUNT || ' records.');
    END bulk_insert_daily_visits;

END hospital_mgmt_pkg;
/

-- EXCEPTION HANDLING EXAMPLES
-- Predefined Exceptions
/*
DECLARE
    p_patient_id patients.patient_id%TYPE := 1;
    v_full_name VARCHAR2(50);
BEGIN
    SELECT first_name || ' ' || last_name
    INTO v_full_name
    FROM patients
    WHERE patient_id = p_patient_id;

    DBMS_OUTPUT.PUT_LINE('Patient Name: ' || v_full_name);

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Patient not found in the system.');
    WHEN TOO_MANY_ROWS THEN
        DBMS_OUTPUT.PUT_LINE('Duplicate patient records detected.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Unexpected error: ' || SQLERRM);
END;
/

-- Custom Exceptions
DECLARE
    e_time_conflict EXCEPTION;
    appointment_exists BOOLEAN;
    v_doctor_id NUMBER := 1;
    v_appointment_time DATE := SYSDATE;
    v_count NUMBER;
BEGIN
    SELECT COUNT(*)
    INTO v_count
    FROM appointments
    WHERE doctor_id = v_doctor_id
      AND appointment_time = v_appointment_time;

    IF v_count > 0 THEN
        appointment_exists := TRUE;
    ELSE
        appointment_exists := FALSE;
    END IF;

    IF appointment_exists THEN
        RAISE e_time_conflict;
    END IF;

    DBMS_OUTPUT.PUT_LINE('Appointment can be scheduled.');

EXCEPTION
    WHEN e_time_conflict THEN
        DBMS_OUTPUT.PUT_LINE('Doctor already has an appointment at this time.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Unexpected error: ' || SQLERRM);
END;
/
*/

-- TESTING PROCEDURES
-- Test procedure: add patient
DECLARE
    v_patient_id NUMBER;
    v_message    VARCHAR2(100);
BEGIN
    add_patient(v_patient_id, 'Test', 'User', 'M', '0788282828', v_message);
    DBMS_OUTPUT.PUT_LINE(v_message);
    DBMS_OUTPUT.PUT_LINE('New Patient ID: ' || v_patient_id);
END;
/

-- Execute the hospital package
SET SERVEROUTPUT ON;
BEGIN
    -- Test the package
    DECLARE
        v_msg VARCHAR2(200);
        v_status VARCHAR2(200);
        v_feedback VARCHAR2(200);
        v_patient_id NUMBER := NULL;
    BEGIN
        -- Test adding a patient
        hospital_mgmt_pkg.add_patient(
            p_patient_id => v_patient_id,
            p_first_name => 'John',
            p_last_name => 'Smith',
            p_gender => 'M',
            p_phone => '1234567890',
            p_message => v_msg
        );
        DBMS_OUTPUT.PUT_LINE('Add Patient: ' || v_msg);
        
        -- Test scheduling an appointment if patient was added
        IF v_patient_id IS NOT NULL THEN
            hospital_mgmt_pkg.schedule_appointment(
                p_patient_id => v_patient_id,
                p_doctor_id => 1,
                p_date => SYSDATE,
                p_notes => 'Regular checkup',
                p_status => v_status
            );
            DBMS_OUTPUT.PUT_LINE('Schedule Appointment: ' || v_status);
        END IF;
        
        -- Test other functions
        IF v_patient_id IS NOT NULL THEN
            DBMS_OUTPUT.PUT_LINE('Patient Age: ' || hospital_mgmt_pkg.get_patient_age(v_patient_id));
            DBMS_OUTPUT.PUT_LINE('Doctor Exists (ID=1): ' || hospital_mgmt_pkg.doctor_exists(1));
            DBMS_OUTPUT.PUT_LINE('Appointment Count: ' || hospital_mgmt_pkg.count_patient_appointments(v_patient_id));
        END IF;
    END;
END;
/

-- Re-enable triggers
BEGIN
    EXECUTE IMMEDIATE 'ALTER TRIGGER trg_appointments_restrict_hospital ENABLE';
    EXECUTE IMMEDIATE 'ALTER TRIGGER trg_patients_compound_hospital ENABLE';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

COMMIT;
